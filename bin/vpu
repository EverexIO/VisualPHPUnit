#!/usr/bin/env php
<?php
    require dirname(__DIR__) . '/app/config/bootstrap.php';

    use \app\lib\PDO_MySQL;

    $opts  = array(
        'f:'  => 'xml_configuration_file:',
        'd::' => 'snapshot_directory::',
        'e::' => 'sandbox_errors::',
        's::' => 'store_statistics::',
        't::' => 'time::',
        'p::' => 'project::'
    );
    $options = getopt(implode(array_keys($opts)), array_values($opts));

    if ( isset($options['f']) ) {
        $xml_config = $options['f'];
    } elseif ( isset($options['xml_configuration_file']) ) {
        $xml_config = $options['xml_configuration_file'];
    } else {
        $xml_config = false;
    }
    if ( !$xml_config || !$xml_config = realpath($xml_config) ) {
        die(
            "A valid xml_configuration_file must be specified "
            . "[-f|--xml_configuration_file] for VPU to work.\n"
        );
    }

    $vpu = new \app\lib\VPU();

    if ( isset($options['e']) || isset($options['sandbox_errors']) ) {
        $sandbox_errors = true;
    } else {
        $sandbox_errors = \app\lib\Library::retrieve('sandbox_errors');
    }
    if ( $sandbox_errors ) {
        error_reporting(\app\lib\Library::retrieve('error_reporting'));
        set_error_handler(array($vpu, 'handle_errors'));
    }

    $results = $vpu->run_with_xml($xml_config);
    $results = $vpu->compile_suites($results, 'cli');

    if ( $sandbox_errors ) {
        restore_error_handler();
    }

    $suites = $results['suites'];
    $stats = $results['stats'];
    $errors = $vpu->get_errors();
    $to_view = compact('suites', 'stats', 'errors');

    $time = time();
    if ( isset($options['t']) ) {
        $time = (int)$options['t'];
    }

    $project = '';
    if ( isset($options['p']) ) {
        $project = $options['p'] . '_';
    }
    if ( isset($options['d']) ) {
        $filename = $options['d'];
        $snapshot_error = '[-d]';
    } elseif ( isset($options['snapshot_directory']) ) {
        $filename = $options['snapshot_directory'];
        $snapshot_error = '[--snapshot_directory]';
    } else {
        $filename = \app\lib\Library::retrieve('snapshot_directory');
        $snapshot_error = 'the snapshot_directory in app/config/bootstrap.php';
    }
    $filename = realpath($filename) . '/' . $project . date('Y-m-d_H-i', $time) . '.html';

    $handle = @fopen($filename, 'a');
    if ( !$handle ) {
        die(
            "There was an error creating the snapshot.  Please ensure that "
            . "{$snapshot_error} exists and has the proper permissions.\n"
        );
    }

    $view = new \app\core\View();
    $contents = $view->render('partial/test_results', $to_view);

    fwrite($handle, $contents);
    fclose($handle);

    echo "Snapshot successfully created at {$filename}.\n";

    if ( isset($options['s']) || isset($options['store_statistics']) ) {
        $store_statistics = true;
    } else {
        $store_statistics = \app\lib\Library::retrieve('store_statistics');
    }
    if ( !$store_statistics ) {
        exit;
    }

    $email = \app\lib\Library::retrieve('email');
    if($email){
        $ok = $stats['tests']['succeeded'] == $stats['tests']['total'];
        mail(
            $email,
            sprintf(
                "[ UNIT TESTS from %s ] %s",
                getenv('NODE_ENV'),
                $ok ? "OK" : "PROBLEMS"
            ),
            sprintf(
                "Succeeded: %d / %d (%.2f %)\n" .
                "Skipped: %d / %d (%.2f %)\n" .
                "Incomplete: %d / %d (%.2f %)\n" .
                "Failed: %d / %d (%.2f %)\n",
                $stats['tests']['succeeded'], $stats['tests']['total'], $stats['tests']['percentSucceeded'],
                $stats['tests']['skipped'], $stats['tests']['total'], $stats['tests']['percentSkipped'],
                $stats['tests']['incomplete'], $stats['tests']['total'], $stats['tests']['percentIncomplete'],
                $stats['tests']['failed'], $stats['tests']['total'], $stats['tests']['percentFailed']
            )
        );
    }

    $db_options = \app\lib\Library::retrieve('db');
    $db = new $db_options['plugin']();
    if ( !$db->connect($db_options) ) {
        die(
            "There was an error connecting to the database:\n"
            . implode(' ', $db->get_errors()) . "\n"
        );
    }

    $now = date('Y-m-d H:i:s', $time);
    $date = date('Y-m-d', $time);

    // print_r($results);die;###
    foreach ( $stats as $key => $stat ) {
        $sql =
            "SELECT `id`, `details` " .
            "FROM `details` " .
            "WHERE " .
                "`run_date` = ? AND " .
                "`type` = ?";
        if(!$db->query(
            $sql,
            array(
                $date,
                $key
            )
        )){
            die("SQL errors:\n" . implode(' ', $db->get_errors()) . "\n");
        }
        $res = $db->fetch(PDO::FETCH_ASSOC);

        if($res){
            $detailsId = $res['id'];
            $details = unserialize($res['details']);
            if(!isset($details['real_total_date'])){
                $details['real_total_date'] = $now;
            }
        }else{
            $detailsId = 0;
            $details = array(
                'succeeded'         => 0,
                'skipped'           => 0,
                'incomplete'        => 0,
                'failed'            => 0,
                'total'             => 0,
                'real_total_date'   => $now,
                'real_total'        => 0,
                'data'              => array()
            );
        }
        foreach($stat as $statKey => $value){
            $details[$statKey] += $value;
        }
        $t =
            $stat['succeeded'] +
            $stat['skipped'] +
            $stat['incomplete'] +
            $stat['failed'];
        if($details['real_total_date'] == $now){
            $details['real_total'] += $t;
        }else{
            $details['real_total_date'] == $now;
            $details['real_total'] = $t;
        }

        foreach($results['suites'] as $testName => $aTests){
            foreach($aTests['tests'] as $aTest){
                /*
                if('succeeded' == $aTest['status']){
                    continue;
                }
                */
                $aTest['run_time'] = $now;
                if(!isset($details['data'][$testName])){
                    $details['data'][$testName] = array();
                }
                $details['data'][$testName][] = $aTest;
            }
        }
        if($detailsId){
            if(!$db->update(
                'details',
                array(
                    'details' => serialize($details)
                ),
                array('id' => $detailsId)
            )){
                die("SQL errors:\n" . implode(' ', $db->get_errors()) . "\n");
            }
        }else{
            if(!$db->insert(
                'details',
                array(
                    'run_date' => $date,
                    'type'     => $key,
                    'details'  => serialize($details)
                )
            )){
                die("SQL errors:\n" . implode(' ', $db->get_errors()) . "\n");
            }
            $detailsId = $db->insert_id();
        }

        $table = ucfirst(rtrim($key, 's')) . 'Result';
        $data = array(
            'run_date'   => $now,
            'failed'     => $stat['failed'],
            'incomplete' => $stat['incomplete'],
            'skipped'    => $stat['skipped'],
            'succeeded'  => $stat['succeeded'],
            'id_details' => $detailsId,
        );
        if(!$db->insert($table, $data)){
            die(
                "There was an error inserting a record into the database:\n"
                . implode(' ', $db->get_errors()) . "\n"
            );
        }
    }
    echo "The statistics generated during this test run were successfully "
        . "stored.\n";
