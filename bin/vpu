#!/usr/bin/env php
<?php
    require dirname(__DIR__) . '/app/config/bootstrap.php';

    use \app\lib\PDO_MySQL;

    $opts  = array(
        'f:'  => 'xml_configuration_file:',
        'd::' => 'snapshot_directory::',
        'e::' => 'sandbox_errors::',
        's::' => 'store_statistics::',
        't::' => 'time::',
        'p::' => 'project::'
    );
    $options = getopt(implode(array_keys($opts)), array_values($opts));

    if ( isset($options['f']) ) {
        $xml_config = $options['f'];
    } elseif ( isset($options['xml_configuration_file']) ) {
        $xml_config = $options['xml_configuration_file'];
    } else {
        $xml_config = false;
    }
    if ( !$xml_config || !$xml_config = realpath($xml_config) ) {
        die(
            "A valid xml_configuration_file must be specified "
            . "[-f|--xml_configuration_file] for VPU to work.\n"
        );
    }

    $vpu = new \app\lib\VPU();

    if ( isset($options['e']) || isset($options['sandbox_errors']) ) {
        $sandbox_errors = true;
    } else {
        $sandbox_errors = \app\lib\Library::retrieve('sandbox_errors');
    }
    if ( $sandbox_errors ) {
        error_reporting(\app\lib\Library::retrieve('error_reporting'));
        set_error_handler(array($vpu, 'handle_errors'));
    }

    $results = $vpu->run_with_xml($xml_config);
    $results = $vpu->compile_suites($results, 'cli');

    if ( $sandbox_errors ) {
        restore_error_handler();
    }

    $suites = $results['suites'];
    $stats = $results['stats'];
    $errors = $vpu->get_errors();
    $to_view = compact('suites', 'stats', 'errors');

    $time = time();
    if ( isset($options['t']) ) {
        $time = (int)$options['t'];
    }

    $project = '';
    if ( isset($options['p']) ) {
        $project = $options['p'] . '_';
    }
    if ( isset($options['d']) ) {
        $filename = $options['d'];
        $snapshot_error = '[-d]';
    } elseif ( isset($options['snapshot_directory']) ) {
        $filename = $options['snapshot_directory'];
        $snapshot_error = '[--snapshot_directory]';
    } else {
        $filename = \app\lib\Library::retrieve('snapshot_directory');
        $snapshot_error = 'the snapshot_directory in app/config/bootstrap.php';
    }
    $filename = realpath($filename) . '/' . $project . date('Y-m-d_H-i', $time) . '.html';

    $handle = @fopen($filename, 'a');
    if ( !$handle ) {
        die(
            "There was an error creating the snapshot.  Please ensure that "
            . "{$snapshot_error} exists and has the proper permissions.\n"
        );
    }

    $view = new \app\core\View();
    $contents = $view->render('partial/test_results', $to_view);

    fwrite($handle, $contents);
    fclose($handle);

    echo "Snapshot successfully created at {$filename}.\n";

    if ( isset($options['s']) || isset($options['store_statistics']) ) {
        $store_statistics = true;
    } else {
        $store_statistics = \app\lib\Library::retrieve('store_statistics');
    }
    if ( !$store_statistics ) {
        exit;
    }

    $db_options = \app\lib\Library::retrieve('db');
    $db = new $db_options['plugin']();
    if ( !$db->connect($db_options) ) {
        die(
            "There was an error connecting to the database:\n"
            . implode(' ', $db->get_errors()) . "\n"
        );
    }

    $now = date('Y-m-d H:i:s', $time);
    $dbParams = \app\lib\Library::retrieve('db');
    $dbLink = @mysql_connect($dbParams['host'], $dbParams['username'], $dbParams['password']);
    mysql_select_db($dbParams['database']);

    foreach ( $stats as $key => $stat ) {
        $sql =
            "SELECT `id`, `details` ".
            "FROM `details` " .
            "WHERE " .
                "`run_date` = '" . date('Y-m-d') . "' AND " .
                "`type` = '" . $key . "'";
        ($r = mysql_query($sql)) or die(print_r(mysql_error($dbLink), TRUE));
        if(mysql_num_rows($r)){
            list($detailsId, $details) = mysql_fetch_row($r);
            $details = unserialize($details);
        }else{
            $detailsId = 0;
            $details = array(
                'succeeded'         => 0,
                'skipped'           => 0,
                'incomplete'        => 0,
                'failed'            => 0,
                'total'             => 0,
                'percentSucceeded'  => 0,
                'percentSkipped'    => 0,
                'percentIncomplete' => 0,
                'percentFailed'     => 0,
                'data'              => array()
            );
        }
        foreach($stat as $statKey => $value){
            $details[$statKey] += $value;
        }
        foreach($results['suites'] as $testName => $aTests){
            foreach($aTests['tests'] as $aTest){
                /*
                if('succeeded' == $aTest['status']){
                    continue;
                }
                */
                if(!isset($details['data'][$testName])){
                    $details['data'][$testName] = array();
                }
                $details['data'][$testName][] = $aTest;
            }
        }
        if($detailsId){
            $sql =
                "UPDATE `details` " .
                "SET `details` = '" .
                mysql_real_escape_string(
                    serialize($details),
                    $dbLink
                ) . "' " .
                "WHERE `id` = {$detailsId}";
        }else{
            $sql =
                "INSERT INTO `details` " .
                "SET " .
                    "`run_date` = '" . date('Y-m-d') . "', " .
                    "`type` = '{$key}', " .
                    "`details` = '" .
                    mysql_real_escape_string(
                        serialize($details),
                        $dbLink
                    ) . "'";
        }
        mysql_query($sql) or die(print_r(mysql_error($dbLink), TRUE));
        if(!$detailsId){
            $detailsId = mysql_insert_id();
        }
        $table = ucfirst(rtrim($key, 's')) . 'Result';
        $data = array(
            'run_date'   => $now,
            'failed'     => $stat['failed'],
            'incomplete' => $stat['incomplete'],
            'skipped'    => $stat['skipped'],
            'succeeded'  => $stat['succeeded'],
            'id_details' => $detailsId,
        );
        ($r = mysql_query('select 1 from ' . $table . ' where run_date="'.$now.'"')) or
        die(print_r(mysql_error($dbLink), TRUE));
        if(mysql_num_rows($r)){
            mysql_query(
                "UPDATE `" . $table . "` " .
                "SET " .
                    "`failed` = `failed` + {$data['failed']}, " .
                    "`succeeded` = succeeded + {$data['succeeded']}, " .
                    "`id_details` = {$detailsId} " .
                    "WHERE `run_date` = '$now'"
            ) or die(print_r(mysql_error($dbLink), TRUE));
        }else{
            if(!$db->insert($table, $data)){
                die(
                    "There was an error inserting a record into the database:\n"
                    . implode(' ', $db->get_errors()) . "\n"
                );
            }
        }
    }
    echo "The statistics generated during this test run were successfully "
        . "stored.\n";
